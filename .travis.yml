# Arizen's Travis CI build script for building Linux, MacOS, and Windows release.
os: linux
dist: bionic
language: generic

notifications:
  email: false

git:
  depth: 10

branches:
  only:
  # release tags
  - /^v\d+\.\d+\.\d+.*$/
  - development
  - master

env:
  global:
  - PROJECT_NAME=arizen
  - HOMEBREW_NO_AUTO_UPDATE=1
  - USE_HARD_LINKS=false

addons:
  homebrew:
    update: false
    packages:
      - gnupg
  apt:
    packages:
      - gpg
      - python3-pip
      - python3-setuptools

jobs:
  include:
    - os: osx
      osx_image: xcode10.2
      language: node_js
      node_js: lts/fermium
      env:
        - ELECTRON_CACHE=$HOME/.cache/electron
        - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
    - os: linux
      services: docker

cache:
  npm: false
  directories:
    - $HOME/.cache/electron
    - $HOME/.cache/electron-builder

# skip install, done in script.sh
install: true

script:
  - source ./ci/script.sh

before_cache:
  - rm -rf $HOME/.cache/electron-builder/wine

after_success:
  - sudo pip3 install --upgrade b2
  - ./ci/after_success.sh

deploy:
  edge: true
  provider: releases
  draft: true
  overwrite: true
  token: "${GITHUB_TOKEN}"
  release_notes: Release
  file_glob: true
  file:
    - "./release/*.dmg"
    - "./release/*.zip"
    - "./release/*.exe"
    - "./release/*.nupkg"
    - "./release/*.deb"
    - "./release/*.AppImage"
    - "./release/*.sha256"
  cleanup: false
  on:
    tags: true
